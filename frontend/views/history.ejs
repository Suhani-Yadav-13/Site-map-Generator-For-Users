<% layout('layouts/main') %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10">

      <div class="card shadow-lg border-0 rounded-5">
        <div class="card-header bg-dark text-white fw-bold text-center rounded-top-5">
          ðŸ“œ Your Sitemap History
        </div>

        <div class="card-body p-4">
          <% if (sitemaps && sitemaps.length > 0) { %>
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Date & Time</th>
                  <th>Links</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% sitemaps.forEach(smap => { %>
                  <tr>
                    <td><%= smap.projectName %></td>
                    <td>
                      <%= smap.dateGenerated.toLocaleString('en-IN', { 
                            year: 'numeric', month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit', second: '2-digit' 
                          }) %>
                    </td>
                    <td><%= smap.links.length %></td>
                    <td class="d-flex gap-2">
                      <!-- ðŸ”¹ New button for visualization -->
                      <a href="/sitemap/visual/<%= smap._id %>" class="btn btn-sm btn-outline-success">
                        Visualize
                      </a>

                      <!-- Delete button triggers modal -->
                      <button type="button" class="btn btn-sm btn-outline-danger" 
                              data-bs-toggle="modal" 
                              data-bs-target="#deleteModal" 
                              data-sitemap-id="<%= smap._id %>">
                        Delete
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="alert alert-info text-center rounded-4">
              No sitemap history available yet.
            </div>
          <% } %>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap Modal for Delete Confirmation -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this sitemap? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Pass the sitemap ID to the modal form dynamically
  const deleteModal = document.getElementById('deleteModal');
  deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const sitemapId = button.getAttribute('data-sitemap-id');
    const form = document.getElementById('deleteForm');
    form.action = `/history/${sitemapId}?_method=DELETE`;
  });
</script>
